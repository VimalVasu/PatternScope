/**
 * ═══════════════════════════════════════════════════════════════════
 * FILE: db/migrations/003_trend_suggestions.pseudo
 * ═══════════════════════════════════════════════════════════════════
 *
 * RESPONSIBILITY:
 *   Creates the trend_suggestions table for storing AI-generated insights.
 *   Stores LLM-generated recommendations and actionable insights based on
 *   detected anomalies. Provides the "why" and "what to do" for operators.
 *
 * SYSTEM FIT:
 *   - Third and final migration in sequence
 *   - Stores output from LLM (Ollama) via analysis service
 *   - Bridges ML detection and human action
 *   - Queried by dashboard to display AI insights
 *   - References anomalies table (related_anomalies array)
 *
 * KEY DEPENDENCIES:
 *   → 001_init.sql - Creates traffic_events table
 *   → 002_anomalies.sql - Creates anomalies that suggestions reference
 *   → analysis/services/llm_client.py - Writes to this table
 *
 * CALLED BY:
 *   - db/init.sh migration runner script
 *   - Runs after 001_init.sql and 002_anomalies.sql
 *
 * CALLS:
 *   - PostgreSQL DDL commands (CREATE TABLE, CREATE INDEX)
 * ═══════════════════════════════════════════════════════════════════
 */

// ═══════════════════════════════════════════════════════════════════
// TABLE: trend_suggestions
// Stores AI-generated insights and recommendations
// ═══════════════════════════════════════════════════════════════════

CREATE TABLE IF NOT EXISTS trend_suggestions (

    // ─────────────────────────────────────────────────────────────
    // PRIMARY KEY
    // ─────────────────────────────────────────────────────────────
    id SERIAL PRIMARY KEY,
    /**
     * Auto-incrementing integer ID
     * Returned to analysis service after insertion
     */

    // ─────────────────────────────────────────────────────────────
    // TIMESTAMPS
    // ─────────────────────────────────────────────────────────────
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    /**
     * When this suggestion was generated
     * Used for: Sorting (show newest first), filtering by generation time
     * Indexed for performance
     */

    // ─────────────────────────────────────────────────────────────
    // ANALYZED TIME PERIOD
    // What time window was analyzed to generate this suggestion
    // ─────────────────────────────────────────────────────────────
    time_period_start TIMESTAMPTZ NOT NULL,
    /**
     * Start of the analyzed period
     * Used for: Context, filtering suggestions by analysis period
     * Indexed as part of composite index
     */

    time_period_end TIMESTAMPTZ NOT NULL,
    /**
     * End of the analyzed period
     * Used for: Context, filtering suggestions by analysis period
     * Indexed as part of composite index
     */

    // ─────────────────────────────────────────────────────────────
    // SUGGESTION METADATA
    // ─────────────────────────────────────────────────────────────
    suggestion_type VARCHAR(100),
    /**
     * Type/category of suggestion
     * Example values:
     *   - 'anomaly_summary': General overview of detected anomalies
     *   - 'congestion_alert': Traffic jam warnings
     *   - 'safety_concern': Speed-related safety issues
     * Used for: Categorization, filtering, icon/color selection in UI
     * Indexed for performance
     */

    confidence_level FLOAT,
    /**
     * LLM confidence in this suggestion (0-1)
     * - High (0.8-1.0): Based on strong anomaly signals
     * - Medium (0.5-0.8): Based on moderate signals or fallback
     * - Low (0.0-0.5): Uncertain or generic suggestions
     * Used for: Prioritization, UI emphasis
     */

    // ─────────────────────────────────────────────────────────────
    // MAIN CONTENT
    // ─────────────────────────────────────────────────────────────
    description TEXT NOT NULL,
    /**
     * Human-readable AI-generated suggestion text
     * Typically formatted as bullet points:
     *   • Potential cause analysis
     *   • Safety concerns identified
     *   • Recommended actions
     *
     * Example:
     *   "• Unusual traffic patterns detected during rush hour
     *    • Speed variations suggest possible congestion
     *    • Consider adjusting traffic signal timing
     *    • Monitor for recurring issues"
     *
     * Generated by: Ollama LLM (llama2 model)
     * Used by: Dashboard TrendSuggestions component for display
     */

    // ─────────────────────────────────────────────────────────────
    // RELATIONSHIP TO ANOMALIES
    // ─────────────────────────────────────────────────────────────
    related_anomalies INTEGER[],
    /**
     * Array of traffic_event_ids that triggered this suggestion
     * Links back to specific anomalous events
     * Example: [145, 146, 147, 148]
     *
     * Used for:
     *   - Traceability (which events led to this insight)
     *   - Drill-down functionality (view related anomalies)
     *   - Impact assessment (how many events were affected)
     *
     * Note: Limited to first 10 anomalies to avoid oversized arrays
     */

    // ─────────────────────────────────────────────────────────────
    // ACTION TRACKING
    // ─────────────────────────────────────────────────────────────
    action_taken BOOLEAN DEFAULT FALSE
    /**
     * Has an operator acted on this suggestion?
     * Used for:
     *   - Workflow management
     *   - Filtering actionable vs completed items
     *   - Performance metrics (response time, action rate)
     */
)


// ═══════════════════════════════════════════════════════════════════
// PERFORMANCE INDEXES
// Optimize common query patterns
// ═══════════════════════════════════════════════════════════════════

CREATE INDEX IF NOT EXISTS idx_trend_suggestions_created_at
    ON trend_suggestions(created_at)
/**
 * Optimizes: Time-based filtering, sorting by newest
 * Used by:
 *   - Dashboard displaying recent suggestions
 *   - Filtering suggestions by generation date
 *
 * Example queries:
 *   SELECT * FROM trend_suggestions
 *   WHERE created_at >= '2025-11-07'
 *   ORDER BY created_at DESC
 *   LIMIT 50
 */


CREATE INDEX IF NOT EXISTS idx_trend_suggestions_time_period
    ON trend_suggestions(time_period_start, time_period_end)
/**
 * Optimizes: Filtering by analyzed period
 * Used by:
 *   - Finding suggestions for specific time windows
 *   - Time-range based analysis
 *
 * Example queries:
 *   SELECT * FROM trend_suggestions
 *   WHERE time_period_start >= '2025-11-07 09:00'
 *     AND time_period_end <= '2025-11-07 17:00'
 */


CREATE INDEX IF NOT EXISTS idx_trend_suggestions_type
    ON trend_suggestions(suggestion_type)
/**
 * Optimizes: Filtering by suggestion category
 * Used by:
 *   - Categorized views
 *   - Type-specific filtering
 *
 * Example queries:
 *   SELECT * FROM trend_suggestions
 *   WHERE suggestion_type = 'safety_concern'
 */


/**
 * ═══════════════════════════════════════════════════════════════════
 * DATA FLOW:
 * ═══════════════════════════════════════════════════════════════════
 *
 * 1. Analysis Service → POST /run-analysis
 *    a. Detect anomalies
 *    b. IF anomalies found:
 *       - Build prompt with anomaly summary
 *       - Call Ollama LLM: POST http://ollama:11434/api/generate
 *       - Receive AI-generated suggestion text
 *       - INSERT INTO trend_suggestions
 *          VALUES (period_start, period_end, type, confidence, description, related_ids)
 *       - RETURN suggestion_id
 *
 * 2. Dashboard → GET /trends/suggestions
 *    SELECT id, created_at, time_period_start, time_period_end,
 *           suggestion_type, confidence_level, description,
 *           related_anomalies, action_taken
 *    FROM trend_suggestions
 *    WHERE created_at >= $1 AND created_at <= $2
 *    ORDER BY created_at DESC
 *    LIMIT 50
 *
 * 3. Dashboard Display (TrendSuggestions component)
 *    - Show suggestion cards with formatted text
 *    - Display time period context
 *    - Show confidence badges
 *    - Link to related anomalies
 */


/**
 * ═══════════════════════════════════════════════════════════════════
 * AI INSIGHT PIPELINE:
 * ═══════════════════════════════════════════════════════════════════
 *
 * Raw Data → Detection → LLM → Storage → Display
 *
 * Step 1: Traffic Events Collected
 *   traffic_events table filled by edge-mock publisher
 *
 * Step 2: Anomaly Detection
 *   Analysis service runs algorithms
 *   → anomalies table populated
 *
 * Step 3: Prompt Engineering
 *   Group anomalies by type
 *   Build context-rich prompt:
 *     "Analyze 15 anomalies from 9:00 AM to 5:00 PM:
 *      - 8 detected by zscore
 *      - 7 detected by isolation_forest
 *      Provide 3-5 actionable insights..."
 *
 * Step 4: LLM Generation
 *   Ollama (llama2) generates human-readable text
 *   Returns bullet-pointed recommendations
 *
 * Step 5: Storage
 *   Insert into trend_suggestions table
 *   Link to related anomaly IDs
 *
 * Step 6: Display
 *   Dashboard queries and displays in TrendSuggestions component
 *   Operators review and take action
 */


/**
 * ═══════════════════════════════════════════════════════════════════
 * EXAMPLE SUGGESTION:
 * ═══════════════════════════════════════════════════════════════════
 *
 * id: 42
 * created_at: 2025-11-07 17:30:00
 * time_period_start: 2025-11-07 09:00:00
 * time_period_end: 2025-11-07 17:00:00
 * suggestion_type: 'anomaly_summary'
 * confidence_level: 0.8
 * description:
 *   "Based on the analysis of 15 traffic anomalies from 9:00 AM to 5:00 PM:
 *
 *    • Unusual speed patterns detected during rush hour - vehicles traveling
 *      significantly slower than normal, suggesting potential incidents
 *    • High vehicle density observed at locations 3 and 5, indicating possible
 *      congestion points requiring attention
 *    • Consider investigating camera footage for the affected time periods
 *    • Recommend adjusting traffic signal timing if patterns persist
 *    • Monitor for recurring issues during similar time windows"
 *
 * related_anomalies: [145, 146, 147, 148, 149, 150, 151, 152, 153, 154]
 * action_taken: false
 */
